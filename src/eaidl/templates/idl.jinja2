{% from "idl/gen_notes.jinja2" import gen_notes %}
{% from "idl/gen_annotations.jinja2" import gen_annotations %}
{% from "idl/gen_class.jinja2" import gen_class_declaration, gen_class_definition%}
{# Create module declaration, recursively. #}
{% macro gen_module_declaration(module, loop) %}
{% set module_note = gen_notes(module) %}
{% if module_note | trim %}
{{ module_note }}
{% endif %}
module {{ module.name }} {
{% for submodule in module.packages %}
{{ gen_module_declaration(submodule, loop)| trim | indent(4, true) }}
{% endfor %}
{# Declaration phase: forward declarations must appear before full typedef/enum definitions #}
{# Pass 1: Output forward declarations (struct/union) in dependency order #}
{% for cls in module.classes if cls.is_struct or cls.is_union %}
{% set class_declaration = gen_class_declaration(module, cls) %}
{% if class_declaration | trim %}
{{ class_declaration | trim | indent(4, true) }}
{% endif %}
{% endfor %}
{# Pass 2: Output full definitions (enum/typedef) in dependency order #}
{% for cls in module.classes if cls.is_enum or cls.is_typedef %}
{% set class_declaration = gen_class_declaration(module, cls) %}
{% if class_declaration | trim %}
{{ class_declaration | trim | indent(4, true) }}
{% endif %}
{% endfor %}
}; /* {{module.name}} */
{% endmacro -%}
{# Create module definition, recursively. #}
{% macro gen_module_definition(module, loop) %}
{% if module.info.create_definition == True %}
{% set module_note = gen_notes(module) %}
{% if module_note | trim %}
{{ module_note }}
{% endif %}
module {{ module.name }} {
{% for submodule in module.packages %}
{{ gen_module_definition(submodule, loop) | trim | indent(4, true) }}
{% endfor %}
{% for cls in module.classes %}
{% set class_definition = gen_class_definition(module, cls) %}
{% if class_definition | trim %}
{{ class_definition | trim | indent(4, true) }}
{% endif %}
{% endfor %}
}; /* {{module.name}} */
{% endif %}
{% endmacro -%}
{% for package in packages %}
{# We start with top level module, and create definitions than declarations. #}
module {{package.name}} {
{# Generate definitions for our custom annotations. #}
{% for property_type in package.property_types recursive %}
{% set property_note = gen_notes(property_type) %}
{% if property_note | trim %}
{{ property_note | trim | indent(4, true, false) }}
{% endif %}
    @annotation {{ property_type.property }} {
{% for type in property_type.property_types recursive %}
        {{type}}
{% endfor %}
    };
{% endfor %}
{% for child in package.packages recursive -%}
{{ gen_module_declaration(child, loop) | trim | indent(4, true) }}
{% endfor %}
{% for child in package.packages recursive -%}
{% set module_definition = gen_module_definition(child, loop) %}
{% if module_definition | trim %}
{{ module_definition | trim | indent(4, true) }}
{% endif %}
{% endfor %}
}; /* {{package.name}} */
{%endfor%}
